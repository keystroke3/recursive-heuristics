<!DOCTYPE html>
<html
  lang="en"
  data-theme="light"
>
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  


<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/roboto-slab-latin-400.woff2"
  crossorigin="anonymous"
/>

<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/roboto-slab-latin-700.woff2"
  crossorigin="anonymous"
/>


<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/fira-code-latin-300.woff2"
  crossorigin="anonymous"
/>
<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/fira-code-latin-400.woff2"
  crossorigin="anonymous"
/>

<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/fira-code-latin-700.woff2"
  crossorigin="anonymous"
/>

  
  
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />
  




<title>Today I learned How to Read Stdout in Go Tests</title>

<meta
  name="description"
  content="Being able to read the output of a function can be useful to read some good your tests are failing. Here&amp;rsquo;s how I did it.
The problem# I am currently in the middle of building my lightweight configuration loader called Pluma. I was writing tests for one of the exported helper functions FromEnv which is supposed to read configurations from the environment variables and load them into a map. All the test cases were passing except the ones where the user passes a prefix for the variables."
/>

<link rel="canonical" href="https://blog.okello.io/notes/how-to-read-stdout-in-go-tests/" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Today I learned How to Read Stdout in Go Tests"/>
<meta name="twitter:description" content="Being able to read the output of a function can be useful to read some good your tests are failing. Here&rsquo;s how I did it.
The problem# I am currently in the middle of building my lightweight configuration loader called Pluma. I was writing tests for one of the exported helper functions FromEnv which is supposed to read configurations from the environment variables and load them into a map. All the test cases were passing except the ones where the user passes a prefix for the variables."/>

<meta property="og:title" content="Today I learned How to Read Stdout in Go Tests" />
<meta property="og:description" content="Being able to read the output of a function can be useful to read some good your tests are failing. Here&rsquo;s how I did it.
The problem# I am currently in the middle of building my lightweight configuration loader called Pluma. I was writing tests for one of the exported helper functions FromEnv which is supposed to read configurations from the environment variables and load them into a map. All the test cases were passing except the ones where the user passes a prefix for the variables." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.okello.io/notes/how-to-read-stdout-in-go-tests/" /><meta property="article:section" content="notes" />
<meta property="article:published_time" content="2023-10-15T03:53:40+03:00" />
<meta property="article:modified_time" content="2023-10-15T03:53:40+03:00" />


<meta itemprop="name" content="Today I learned How to Read Stdout in Go Tests">
<meta itemprop="description" content="Being able to read the output of a function can be useful to read some good your tests are failing. Here&rsquo;s how I did it.
The problem# I am currently in the middle of building my lightweight configuration loader called Pluma. I was writing tests for one of the exported helper functions FromEnv which is supposed to read configurations from the environment variables and load them into a map. All the test cases were passing except the ones where the user passes a prefix for the variables."><meta itemprop="datePublished" content="2023-10-15T03:53:40+03:00" />
<meta itemprop="dateModified" content="2023-10-15T03:53:40+03:00" />
<meta itemprop="wordCount" content="823">
<meta itemprop="keywords" content="learning,golang,config,debugging," />








  
  


  








  
  
  
  


<style>
   
  @font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}

/*! CC BY-SA 3.0 License | https://stackoverflow.com/a/36118384/1154965 */@keyframes blink{50%{opacity:0}to{opacity:1}}

/*! MIT License | github.com/schnerring/hugo-theme-gruvbox */:root[data-theme=light]{--bg:var(--bg0);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}[data-theme=light]:root .light--hidden{display:none}:root[data-theme=dark]{--bg:var(--bg0);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}[data-theme=dark]:root .dark--hidden{display:none}:root{--primary:var(--blue1);--primary-alt:var(--blue2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{word-wrap:break-word;background:var(--bg);color:var(--fg);line-height:1.675}strong{letter-spacing:.35px}a{color:inherit;-webkit-text-decoration:none;text-decoration:none}a.link--external:after{content:"\2009↗"}img{border:2px solid var(--bg1);height:auto;max-width:100%}figure{display:inline-block}figcaption{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:.9rem}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code{font-size:1em}h2,h3,h4{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre{background:var(--bg1)}code,pre{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote:not(.does-not-exist) code{background:var(--bg2)}blockquote:not(.does-not-exist) p:first-of-type{margin-top:0}blockquote:not(.does-not-exist) p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,650px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.search__no-results{padding:.75rem}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}nav#menu .menu__burger input:checked~ul.menu--vertical{transform:none}nav#menu .menu__burger input:checked~svg{stroke:var(--bg1)}@media (min-width:768px){nav#menu .menu__burger{display:none}}.post-preview{margin-left:5%;max-width:90%}.post-preview-header{color:var(--blue1);font-size:1.4rem}.post-preview-content{font-size:.9rem;font-weight:300}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar svg{fill:var(--fg)}.sidebar__heading{font-size:1.3rem}aside.toc a{color:var(--blue2);color:var(--primary-alt)}aside.toc a:hover{color:var(--blue1);color:var(--primary)}aside.toc ul{list-style:none;margin:0;padding:0}aside.toc ul ul{font-size:.9rem;margin-left:.5rem}aside.toc ul li{line-height:1.1}aside.toc ul li a{display:block;padding:.2rem 0}.tag__active{background-color:var(--bg2);color:var(--fg);padding-left:.2rem;padding-right:.2rem}.content-section,.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post figure,.post img:not(figure img){box-sizing:border-box;margin:.5rem 0}.post-content__read-more,.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-meta__author{font-weight:700}.post-content{margin:1.3rem 0}.post-content__read-more{margin-top:1.3rem}.post-content a,.post-content__read-more,.post-header a{color:var(--blue2);color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--blue1);color:var(--primary)}.post-tags{align-items:center;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor{display:inline-block}
   
</style>

<link
  rel="preload"
  href="/css/non-critical.a695b88a0957271618f786794127c4dc409c85101336d84e8b2c6e10556b20c68008fa60877756c974b9b57949bdc786fe767cfdaaa4af046414a977b5d5c2a3.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  
    integrity="sha512-ppW4iglXJxYY94Z5QSfE3ECchRATNthOiyxuEFVrIMaACPpgh3dWyXS5tXlJvceG/nZ8/aqkrwRkFKl3tdXCow=="
  
/>


<link
  id="prism-dark"
  rel="preload"
  href="/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="
  disabled
/>


<link
  id="prism-light"
  rel="preload"
  href="/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  
    integrity="sha512-QqIhdB7&#43;mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A=="
  
  
/>

<noscript>
  
    <link
      rel="stylesheet"
      href="/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css"
      
        integrity="sha512-QqIhdB7&#43;mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A=="
      
    />
  


  <link
    rel="stylesheet"
    href="/css/non-critical.a695b88a0957271618f786794127c4dc409c85101336d84e8b2c6e10556b20c68008fa60877756c974b9b57949bdc786fe767cfdaaa4af046414a977b5d5c2a3.css"
    
      integrity="sha512-ppW4iglXJxYY94Z5QSfE3ECchRATNthOiyxuEFVrIMaACPpgh3dWyXS5tXlJvceG/nZ8/aqkrwRkFKl3tdXCow=="
    
  />
</noscript>


  

  




<script>
  (()=>{function c(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function n(t){document.documentElement.setAttribute("data-theme",t);let e=document.getElementById("prism-dark"),i=document.getElementById("prism-light");e.toggleAttribute("disabled",t==="light"),i.toggleAttribute("disabled",t==="dark"),localStorage.setItem("theme",t)}var o=c();o&&n(o);function l(t){let e=t.currentTarget.classList.contains("light--hidden")?"light":"dark";n(e)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(e=>{e.addEventListener("click",l)})});})();

</script>


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest" />
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#282828" />
<meta name="msapplication-TileColor" content="#282828" />
<meta name="theme-color" content="#282828" />



  
  

</head>

  <body>
    <div class="layout">
      <header>
  <a
    class="logo"
    href="/"
  >
    
      <div class="logo__text">RH</div>
    
    <div class="logo__chevron">></div>
    <div class="logo__cursor">█</div>
  </a>

  <div class="search">
    <input
      id="search__text"
      type="search"
      placeholder="Search..."
      aria-label="Search"
      autocomplete="off"
    />
    <div id="search__suggestions" class="search__suggestions--hidden"></div>
  </div>

  <nav id="menu">
    <ul class="menu--horizontal">
      
        <li class="menu__item">
          <a href="/tutorials/">How-To</a>
        </li>
      
        <li class="menu__item">
          <a href="https://okello.io">About</a>
        </li>
      
    </ul>

    <div class="menu__burger">
      
      <input class="menu__item" type="checkbox" aria-label="Open main menu" />

      
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 6l16 0" />
  <path d="M4 12l16 0" />
  <path d="M4 18l16 0" />
</svg>







      <ul class="menu--vertical">
        
          <li>
            <a class="menu__item" href="/tutorials/">How-To</a>
          </li>
        
          <li>
            <a class="menu__item" href="https://okello.io">About</a>
          </li>
        
      </ul>
    </div>
  </nav>

  <button class="theme__toggle light--hidden" aria-label="Toggle light mode">
    
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
  <path d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />
</svg>





  </button>

  <button class="theme__toggle dark--hidden" aria-label="Toggle dark mode">
    
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
</svg>





  </button>
  
</header>

      <main>
        <div class="content">
          
  <article class="post">
    <div class="post-header">
      <h1>Today I learned How to Read Stdout in Go Tests</h1>
      <div class="post-meta"><span>2023-10-15</span>
    <div class="post-tags">
      <a class="post-tag" href="https://blog.okello.io/tags/learning">learning</a><a class="post-tag" href="https://blog.okello.io/tags/golang">golang</a><a class="post-tag" href="https://blog.okello.io/tags/config">config</a><a class="post-tag" href="https://blog.okello.io/tags/debugging">debugging</a>
    </div>
  

  
</div>

    </div>

    <div class="post-content">
      <p>Being able to read the output of a function can be useful to read some good your tests are failing. Here&rsquo;s how I did it.</p>
<h2 id="the-problem">The problem<a href="#the-problem" class="post-heading__anchor" aria-hidden="true">#</a>
</h2>
<p>I am currently in the middle of building my lightweight configuration loader called <a
  href="https://github.com/keystroke3/pluma"
  
  
    class="link--external" target="_blank" rel="noreferrer"
  
>Pluma</a>. I was writing tests for one of the
exported helper functions <code>FromEnv</code> which is supposed to read configurations from the environment variables and load them into a map. All the test cases were passing
except the ones where the user passes a prefix for the variables.</p>
<p>Here a cut-down version of the test file for context:</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">pluma</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;bytes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">mockConfig</span> <span style="color:#66d9ef">struct</span>{ <span style="color:#a6e22e">opts</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestFromEnv</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prefix</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;TEST_&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// construct keys and options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">keys</span>   []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">prefix</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">expect</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">name</span>   <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	}{
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">keys</span>:   <span style="color:#a6e22e">keys</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">expect</span>: <span style="color:#a6e22e">options</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">name</span>:   <span style="color:#e6db74">&#34;Lowercase keys without prefix, expect full config&#34;</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">keys</span>:   <span style="color:#a6e22e">keys</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">expect</span>: <span style="color:#a6e22e">options</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">prefix</span>: <span style="color:#a6e22e">prefix</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">name</span>:   <span style="color:#e6db74">&#34;Lowercase keys with prefix, expect full config&#34;</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">test</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mockConfig</span>{<span style="color:#a6e22e">opts</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">FromEnv</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">keys</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cfg</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">prefix</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expect</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Test Failed, expect %v, have %v&#34;</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expect</span>, <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">opts</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Suppose we have a variable <code>foo</code> defined set to <code>bar</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export BUZ<span style="color:#f92672">=</span>fiz
</span></span><span style="display:flex;"><span>export TEST_FOO<span style="color:#f92672">=</span>bar
</span></span></code></pre></div><p>There were no errors with the first test without a prefix. <code>BUZ</code> is loaded as expected.
If we set a prefix of <code>TEST_</code> then FOO should be set to bar in the config, but that doesn&rsquo;t happen. Instead, we get this error message.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">Test</span> <span style="color:#a6e22e">Failed</span>, <span style="color:#a6e22e">expect</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">FOO</span>:<span style="color:#a6e22e">bar</span>] <span style="color:#a6e22e">have</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">FOO</span>:]
</span></span></code></pre></div><p>Without knowing the internal state of the function, it is difficult to debug it without running it normally. This is only one test case, i.e. if the function correctly handles a prefix.
In a normal test file, there can be dozens of test cases, it can be very impractical to have to run the function, or the entire program just so we can use the debugger. Adding log statements
can be a bit faster to find the problem and then get rid of them when debugging is over.</p>
<h2 id="the-solution">The solution<a href="#the-solution" class="post-heading__anchor" aria-hidden="true">#</a>
</h2>
<p>When we run automated tests, only the error messages defined in the tests are printed when a test fails. Any standard output (stdout) messages are ignored. To solve this, we can temporally redirect
the logs to a different place then read from there.<br>
One option is to use a file, but seeing as we are working with (probably) unit tests, we want to keep our requirements as low as possible.
Lucky for us, interfaces are king in Go and any writer that implements <code>io.Writer</code> will do. We will just need to find a way to read from where that writer is writing.
The best writer for this case is the <code>bytes.Buffer</code>. Is both an <code>io.Reader</code> and <code>io.Writer</code>  so we can use it to quickly save our tests&rsquo; output and read it later.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">bf</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">SetOutput</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">bf</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Cleanup</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">SetOutput</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FromEnv</span>(<span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">keys</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cfg</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">prefix</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DeepEqual</span>(<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expect</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Test Failed, expect %v, have %v&#34;</span>, <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">expect</span>, <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">opts</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">bf</span>.<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>In this iteration of the code, we are creating a new buffer with <code>var bf bytes.Buffer</code> and switching the default log output from <code>os.Stdout</code> to our newly created buffer. We are then calling the function being tested, in this case, FromEnv, and checking output validity.<br>
Just like with all resources in Go, we must remember to clean up and close them after, so why not schedule a clean-up so we don&rsquo;t forget?
The anonymous function in <code>t.Cleanup()</code> will be run when all the tests and sub-tests have completed. It will return normal log output to <code>os.Stdout</code> allowing us to read what we stored in our buffer <code>bf</code> by calling <code>t.Log(bf.String())</code>. I don&rsquo;t know about you, but I can&rsquo;t read binary, so we convert the buffer to a string before logging it.</p>
<p>This only works with <code>log</code> statements, not <code>fmt.Print</code> and friends. I will keep looking for a way to show the <code>fmt.Print</code> statements as well, but I think it is better to only have it in logs. We don&rsquo;t want to print debug messages to the client in a production environment. If you know a way to do it with fmt, write a comment or send me an email or dm on twitter.</p>
<h2 id="the-bug">The bug<a href="#the-bug" class="post-heading__anchor" aria-hidden="true">#</a>
</h2>
<p>So after making this change to the test, I added some log statements and discovered that the lookup key was actually set to <code>TEST__FOO</code> and not <code>TEST_FOO</code> as expected. Turns out I was adding an underscore after the prefix. I prefer if the user explicitly adds the underscore, so I have removed the automatic addition.
I don&rsquo;t know how long it would have taken me to discover the bug. I am also glad I wrote the test because that bug would have gone into production and caused more problems than the Pluma is aiming to solve.</p>

    </div>

    

    
  </article>

        </div>
        <div class="sidebar">
  
    
      <aside class="toc">
        <nav>
          <p class="sidebar__heading">Table Of Contents</p>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem">The problem</a></li>
    <li><a href="#the-solution">The solution</a></li>
    <li><a href="#the-bug">The bug</a></li>
  </ul>
</nav>
        </nav>
      </aside>
      <hr />
    
  

  
    <aside class="tag__cloud">
      










<div id="tag-cloud" style="padding: 5px 15px">
    
    
    
    
    
    
    <a href="/tags/algorithms"
        style="font-size:2.0239092917289776rem">algorithms</a>
    
    
    
    
    
    
    <a href="/tags/big-o"
        style="font-size:1.6460148371100896rem">big-o</a>
    
    
    
    
    
    
    <a href="/tags/config"
        style="font-size:1rem">config</a>
    
    
    
    
    
    
    <a href="/tags/debugging"
        style="font-size:1rem">debugging</a>
    
    
    
    
    
    
    <a href="/tags/django"
        style="font-size:1.6460148371100896rem">django</a>
    
    
    
    
    
    
    <a href="/tags/dsa"
        style="font-size:2.292029674220179rem">dsa</a>
    
    
    
    
    
    
    <a href="/tags/explainer"
        style="font-size:2.0239092917289776rem">explainer</a>
    
    
    
    
    
    
    <a href="/tags/golang"
        style="font-size:2.292029674220179rem">golang</a>
    
    
    
    
    
    
    <a href="/tags/json"
        style="font-size:1rem">json</a>
    
    
    
    
    
    
    <a href="/tags/learning"
        style="font-size:1rem">learning</a>
    
    
    
    
    
    
    <a href="/tags/permissions"
        style="font-size:1rem">permissions</a>
    
    
    
    
    
    
    <a href="/tags/python"
        style="font-size:2.0239092917289776rem">python</a>
    
    
    
    
    
    
    <a href="/tags/recursion"
        style="font-size:1rem">recursion</a>
    
    
    
    
    
    
    <a href="/tags/security"
        style="font-size:1rem">security</a>
    
    
    
    
    
    
    <a href="/tags/tutorial"
        style="font-size:2.0239092917289776rem">tutorial</a>
    
</div>

    </aside>
  

</div>

      </main>
      <footer>
  <div class="copyright">
    
  </div>
</footer>



  







  
  



<script src="/js/main.93f2afc43f607a57e1b567f73a1509f24ce17810a62aea20bc84cd15fd5c1cb623be1fa949d7eb654a35c2bdf76089ba25637e99022969fdeac2746c0500a91a.js" integrity="sha512-k/KvxD9gelfhtWf3OhUJ8kzheBCmKuogvITNFf1cHLYjvh&#43;pSdfrZUo1wr33YIm6JWN&#43;mQIpaf3qwnRsBQCpGg=="></script>
<script src="/js/flexsearch.d8f410c81e4f2c3c795ee32b2916fe93a963c67997ce45e70a347553c55143c741c1fd6bc347bad0c0f2fcddaf446f3cee345b0b0b92994dcf845bc0ac7a64c1.js" integrity="sha512-2PQQyB5PLDx5XuMrKRb&#43;k6ljxnmXzkXnCjR1U8VRQ8dBwf1rw0e60MDy/N2vRG887jRbCwuSmU3PhFvArHpkwQ=="></script>






    </div>
  </body>
</html>
