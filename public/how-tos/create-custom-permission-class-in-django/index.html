<!DOCTYPE html>
<html lang="en-us"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name"> | Recursive Heuristics</title>
<meta property="og:title" content=" | Recursive Heuristics" />
<meta name="twitter:title" content=" | Recursive Heuristics" />
<meta itemprop="name" content=" | Recursive Heuristics" />
<meta name="application-name" content=" | Recursive Heuristics" />
<meta property="og:site_name" content="" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />



  <meta itemprop="image" content="https://blog.okello.io" />
  <meta property="og:image" content="https://blog.okello.io" />
  <meta name="twitter:image" content="https://blog.okello.io" />
  <meta name="twitter:image:src" content="https://blog.okello.io" />





<meta name="generator" content="Hugo 0.115.4">

    

    <link rel="canonical" href="https://blog.okello.io/how-tos/create-custom-permission-class-in-django/">
    <link href="/style.min.d966cf3fd65eee963e5a35644facd2d3dbb1157c5a4797166e2692d49cfb1651.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="https://blog.okello.io/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    </head>
<body data-theme = "" class="notransition">

<script src="/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="https://blog.okello.io/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title"></h1>
                
            </header><div class="page-content">
                <p>Permissions can be a hustle to deal with when developing an api. Suppose we have a number of api views and endpoints where the access permissions are very similar to one another with only slight variations.<br>
We could create different permission classes with the slight changes that fit the specific endpoint&rsquo;s needs. That works, but that involves a lot of repetition and duplicated code that can be hard to update later down the line.</p>
<p>This is where an abstract or generic permission class comes in handy. We can define template permissions and logic that can be inherited and extended by child permission classes or the modified in the ViewSet class like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># views.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> somewhere <span style="color:#f92672">import</span> AbstractPermission
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyViewSet</span>(viewsets<span style="color:#f92672">.</span>ModelViewSet):
</span></span><span style="display:flex;"><span>    serializer_class <span style="color:#f92672">=</span> MySerializer
</span></span><span style="display:flex;"><span>    permission_classes <span style="color:#f92672">=</span> (AbstractPermission,)
</span></span><span style="display:flex;"><span>    deny_action <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CLIENT&#34;</span>: (<span style="color:#e6db74">&#34;create&#34;</span>,)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h3 id="defining-our-structure">Defining our structure</h3>
<p>To get started, we can have an example project for CozyCoin Bank with branches in different countries. Each branch has one manager, several clerks, and marketers. CozyCoin customers are rich and can also have multiple bank accounts. Below are our simple models. I have only included fields necessary for explanations.
All the user models inherit from a default user model class were the common fields for all users are defined. For our specific case, we are using the <code>roles</code> field to specify which group the user falls under, but you can use django groups if you wish. I find assigning roles much easier to manage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># models.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(AbstractBaseUser):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Roles</span>(models<span style="color:#f92672">.</span>TextChoices):
</span></span><span style="display:flex;"><span>        MANAGER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;MANAGER&#34;</span>, <span style="color:#e6db74">&#34;Manager&#34;</span>
</span></span><span style="display:flex;"><span>        SUPPORT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SUPPORT&#34;</span>, <span style="color:#e6db74">&#34;Support&#34;</span>
</span></span><span style="display:flex;"><span>        CLERK <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CLERK&#34;</span>, <span style="color:#e6db74">&#34;Clerk&#34;</span>
</span></span><span style="display:flex;"><span>        CUSTOMER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUSTOMER&#34;</span>, <span style="color:#e6db74">&#34;Customer&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BankBranch</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    manager <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ForeignKey(Manager, on_delete<span style="color:#f92672">=</span>models<span style="color:#f92672">.</span>CASCADE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Customer</span>(User):
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, default<span style="color:#f92672">=</span>User<span style="color:#f92672">.</span>Roles<span style="color:#f92672">.</span>CUSTOMER) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Manager</span>(User):
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, default<span style="color:#f92672">=</span>User<span style="color:#f92672">.</span>Roles<span style="color:#f92672">.</span>MANAGER) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Clerk</span>(User):
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, default<span style="color:#f92672">=</span>User<span style="color:#f92672">.</span>Roles<span style="color:#f92672">.</span>CLERK) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Support</span>(User):
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, default<span style="color:#f92672">=</span>User<span style="color:#f92672">.</span>Roles<span style="color:#f92672">.</span>SUPPORT) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Account</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    customer <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ForeignKey(Customer, on_delete<span style="color:#f92672">=</span>models<span style="color:#f92672">.</span>CASCADE)
</span></span><span style="display:flex;"><span>    bank_branch <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ForeignKey(Bank, on_delete<span style="color:#f92672">=</span>models<span style="color:#f92672">.</span>CASCADE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transactions</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    account <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ForeignKey(Account, on_delete<span style="color:#f92672">=</span>models<span style="color:#f92672">.</span>CASCADE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>Let&rsquo;s assume that the serializers and views have also been setup with a sample viewset looking like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># views.py</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SomeModelViewSet</span>(viewsets<span style="color:#f92672">.</span>ModelViewSet):
</span></span><span style="display:flex;"><span>    serializer_class <span style="color:#f92672">=</span> SomeModelSerializer
</span></span><span style="display:flex;"><span>    permission_classes <span style="color:#f92672">=</span> (SomePermissionClass,) <span style="color:#75715e"># this is the important part</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_queryset</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># your queryset logic here</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><h2 id="creating-the-abstract-permission-class">Creating the abstract permission class</h2>
<h3 id="a-basic-permission-class">A basic permission class</h3>
<p>In order to determine if a user has permissions depending on their role, we first have to create an abstract permission class that inherits from rest framework&rsquo;s <code>BasePermission</code>.
We will deny any anonymous request since we require the user to be logged in to view their role. If you don&rsquo;t have an account of any sort with CozyCoin, then you shouldn&rsquo;t have access to anything protected by these permissions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> rest_framework <span style="color:#f92672">import</span> permissions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IsRole</span>(permissions<span style="color:#f92672">.</span>BasePermission):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_permission</span>(self, request, view):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>is_anonymous:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_object_permission</span>(self, request, view, obj):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>For our permissions to be effective, we first have to determine if the user making the request is in the desired group.
The <code>role</code> property is initialized to <code>None</code> and is supposed to be modified in the child classes. If it is not, then <code>SomeError</code>is raised.
<code>SomeError</code> being an error of your choosing. This will ensure that the permissions don&rsquo;t silently fail and deny all requests since the <code>role</code> will always be <code>None</code> and therefor not match any roles.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions.py</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IsRole</span>(permissions<span style="color:#f92672">.</span>BasePermission):
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_permission</span>(self, request, view):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>is_anonymous:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>has_role(request):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_object_permission</span>(self, request, view, obj):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>has_role(request)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_role</span>(self, request) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>role <span style="color:#f92672">==</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> SomeError
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>role <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>role
</span></span></code></pre></div><p>And that&rsquo;s it! We can create child classes that specify the roles we want to grant access to. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># views.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> some_location.permissions <span style="color:#f92672">import</span> IsRole
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IsCustomer</span>(IsRole):
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUSTOMER&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomerOnlyView</span>(viewsets<span style="color:#f92672">.</span>ViewSet):
</span></span><span style="display:flex;"><span>    permission_classes <span style="color:#f92672">=</span> (IsCustomer,)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span></code></pre></div><h3 id="granting-only-the-owner-of-an-object-permissions">Granting only the owner of an object permissions</h3>
<p>The permissions we have defined above are perfectly usable, but if you are keen you might have noticed a problem. Taking the <code>IsCustomer</code> permissions for example, if the request user is not a customer they will be blocked just fine. The problem is the customer can  request for any customer data that is not theirs and it will be granted to them. This means that any customer can view any other customer&rsquo;s data in a view protected by these permissions. To help with this issue, we need to tweak our <code>has_object_permission</code> method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions.py</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_object_permission</span>(self, request, view, obj):
</span></span><span style="display:flex;"><span>        owner <span style="color:#f92672">=</span> getattr(obj, self<span style="color:#f92672">.</span>role<span style="color:#f92672">.</span>lower())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> owner<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>id
</span></span></code></pre></div><p>With this small tweak, instead of just giving any data to anyone so long as they have a certain role, we will be able to only limit the
data to what they own or is linked to them. This assumes that the foreign key field pointing to the user table is named the same as the role but in all lowercase. This means that if the role is <code>CLIENT</code>, then the foreign key field in the model is called <code>client</code>. An alternative it to get the name of the fields to check at runtime instead of relying on the role name which could be different.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IsRole</span>(permissions<span style="color:#f92672">.</span>BasePermission):
</span></span><span style="display:flex;"><span>    owner_field <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_object_permission</span>(self, request, view, obj):
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> getattr(obj, self<span style="color:#f92672">.</span>owner_field <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>role<span style="color:#f92672">.</span>lower()))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IsCustomer</span>(IsRole):
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CUSTOMER&#34;</span>
</span></span><span style="display:flex;"><span>    owner_field <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;client&#34;</span>
</span></span></code></pre></div><h3 id="granting-privileged-users-access">Granting privileged users access</h3>
<p>Wait, what if the person asking for the data has higher access rights like an admin or us? We don&rsquo;t want to make the managers feel less powerful. We have different ways we can deal with this problem. How you approach it will depend on what you named your abstract class and how abstract you want to go. The first approach is to use a variable that grants a set of user roles access. In this example, we can name the field <code>allow_staff</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IsRole</span>(permissions<span style="color:#f92672">.</span>BasePermission):
</span></span><span style="display:flex;"><span>    allow_staff <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    staff_roles <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;ADMIN&#34;</span>, <span style="color:#e6db74">&#34;MANAGER&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_permission</span>(self, request, view, obj):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>allow_staff <span style="color:#f92672">and</span> request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>role <span style="color:#f92672">in</span> staff_roles:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_object_permission</span>(self, request, view, obj):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>allow_staff <span style="color:#f92672">and</span> request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>role <span style="color:#f92672">in</span> staff_roles:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span></code></pre></div><p>With this approach, we can define the <code>staff_roles</code> and set <code>allow_staff</code> to true to give the people with <code>staff_roles</code> access. If we want to go even more abstract then we can use the second approach were we can define <code>allow_roles</code> instead of <code>staff_roles</code>. With this we don&rsquo;t need to check if <code>allow_staff</code> is true or not, we just check if the current user role is one of the special ones.</p>
<h3 id="grant-access-by-view-action">Grant access by view action</h3>
<p>Now, that we can filter permissions by roles, we can also try filtering by the action being performed. For example we might not want a support staff member should not be able to view all the customers and their data in one place at once. (This is only useful with a non-incremental system object ID. There&rsquo;s nothing stopping Joe from going up the number of client IDs from one in an incremental system). We might want them to only have access to the specific client asking for support and only for a short period of
time or after they have been per-approved by a client issue ticket handling system. Also when Bob from marketing wants to send an email to all customers over 35, who look like they could use a loan, he will need not any permissions to modify customer data. So we will give him and his team read only access.</p>
<p>To achieve this, we can add it another attribute <code>deny_actions</code> to the abstract class. This attribute can be a list containing actions we want to deny on that endpoint. We can then check for the list in the <code>has_permission</code> method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions.py</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>deny_actions <span style="color:#f92672">and</span> view<span style="color:#f92672">.</span>action <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>deny_actions:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p>This solution is simple, but it will also deny any special privileged users from performing the actions. We can change it up slightly by making <code>deny_actions</code> accept a dictionary with the user roles as the keys and denied roles as the values. e.g:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>deny_actions <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;MARKETING&#34;</span>: [<span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can put the logic for that in a separate class method and only call it when we need to. We also raise an exception in case the values are not formatted correctly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions.py</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_action_denied</span>(self, request, view):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(self<span style="color:#f92672">.</span>deny_actions, dict):
</span></span><span style="display:flex;"><span>            actions <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>deny_actions<span style="color:#f92672">.</span>get(request<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>role)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> isinstance(self<span style="color:#f92672">.</span>deny_actions, list <span style="color:#f92672">|</span> tuple):
</span></span><span style="display:flex;"><span>            actions <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>deny_actions
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid type </span><span style="color:#e6db74">{</span>type(self<span style="color:#f92672">.</span>deny_actions)<span style="color:#e6db74">}</span><span style="color:#e6db74"> for deny_actions. Expected iterable&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> actions <span style="color:#f92672">and</span> view<span style="color:#f92672">.</span>action <span style="color:#f92672">in</span> actions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><h3 id="getting-values-from-the-view">Getting values from the view</h3>
<p>Sometimes you do not want to create an entire class just so you can change 1 value and use it on one view only. What would be point of doing all this work? We just need to have a bit more code and logic.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions.py</span>
</span></span><span style="display:flex;"><span>    deny_actions <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    allow_roles <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    allow_staff <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_permission</span>(self, request, view):
</span></span><span style="display:flex;"><span>        deny_actions <span style="color:#f92672">=</span> getattr(view, <span style="color:#e6db74">&#39;deny_actions&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        allow_roles <span style="color:#f92672">=</span> getattr(view, <span style="color:#e6db74">&#39;allow_roles&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        allow_staff <span style="color:#f92672">=</span> getattr(view, <span style="color:#e6db74">&#39;allow_staff&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span></code></pre></div><p>This will allow us to specify the extra values when creating the child permission classes or within the view like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># views.py</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SomeModelViewSet</span>(viewsets<span style="color:#f92672">.</span>ModelViewSet):
</span></span><span style="display:flex;"><span>    serializer_class <span style="color:#f92672">=</span> SomeModelSerializer
</span></span><span style="display:flex;"><span>    permission_classes <span style="color:#f92672">=</span> (IsClient,)
</span></span><span style="display:flex;"><span>    allow_staff <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    deny_actions <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;MANAGER&#34;</span>: [<span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_queryset</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>The part where we fetch the filters can also bring up a problem if you have many of them, or if we increase the filters in the future.
So we define a method that is called by <code>has_permissions</code> method before doing anything.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># permissions.py</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_or_set_attributes</span>(self, request, view):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> attribute <span style="color:#f92672">in</span> dir(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> attribute<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;_&#34;</span>): <span style="color:#75715e"># ignore any magic methods and private variables</span>
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> getattr(self, attribute)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> value <span style="color:#f92672">==</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                setattr(self, attribute, getattr(view, attribute, <span style="color:#66d9ef">None</span>))
</span></span></code></pre></div><h2 id="limitations">Limitations</h2>
<p>So this method of creating things an abstract permissions class is very useful. It means we only have to make a few changes to existing and that&rsquo;s it.
If we need new very specific permissions, we don&rsquo;t have to duplicate some code from somewhere and only change a few things to fit the view. There are some issues with this approach.</p>
<ul>
<li>
<p>Too much code in one place<br>
As we are trying to make the abstract class as versatile and flexible as possible, we have to cram so much logic and checks in it. This can very quickly
become a nightmare to maintain or to read back in 6 months.</p>
</li>
<li>
<p>Long setup time<br>
It took me quite a while to come up with the class and logic. It works well for the most part, but it might be hard to adapt it to a different application.
Is it worth the time it took to make it?  ¯_(ツ)_/¯ Maybe it will be in the long run as I would just copy paste the class into other projects, and instantly
get customizable permissions without defining them once again.</p>
</li>
<li>
<p>Reliance on <code>role</code><br>
If you were to remove the role attribute, major parts of the class will have to be redone or rethought. With this structure, a user can only belong to one role.
This limitation could be overcome by allowing the primary search field to be set in child class or in the viewset.</p>
</li>
<li>
<p>Limited extensibility<br>
There is only so much you can add before it becomes a too much. The best thing at that point would be to create a separate abstract permission class.</p>
</li>
<li>
<p>This only works class based views.
I have not created or tested a function based view version of this code, so it might not work for that use case</p>
</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Thanks for getting to the end. Whether you got here by reading or scrolling or copy pasting. You can find the full permission class on <a href="https://gist.github.com/keystroke3/3166c27ed58abae849f9967d9044db75">github gits</a></p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
</div>
    <small class="footer_copyright">
        © 2023 .
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noreferrer noopener">Hugo blog awesome</a>
        theme on
        <a href="https://gohugo.io" target="_blank" rel="noreferrer noopener">Hugo</a>.
    </small>
</footer>







    
    <script src="https://blog.okello.io/js/main.min.4ee188e1744c19816e95a540b2650ed9f033ea0371e74eac8e717355cfca8741.js" integrity="sha256-TuGI4XRMGYFulaVAsmUO2fAz6gNx506sjnFzVc/Kh0E="></script>

    

</body>
</html>
